---
title: "Land Size Distribution Analysis"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

## Primary Questions Are

* Are there differences between locations in mean land size?
* Is land-size important for determining food security or incomes?
* How much does land size vary in one single location?
* Does predicting the mean, or the median actually tell us anything?
* Can we interactively plot the marginal distribution of land-size, given parameters in a given location?
* If so, can we combine this with census data to answer the question: _based on the data we have, we think there are N farmers with farm-sizes under X ha, with confidence y_
* How would we validate such a model?


## Setup

First lets load the packages that we will need: 

```{r setup, warning=F, message=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
# Data Processing Packages
library(jsonlite)
library(readr)
library(dplyr)
library(tibble)
library(rlang)

# Spatial Packages
library(sf)
library(sp)
library(stars)

# Plotting Packages
library(corrplot)
library(ggplot2)

# Statistical Analysis Pakcages
library(FactoMineR) # Package for dimensionality reduction
library(factoextra) # Package for dimensionality reduction
library(brms) # Bayesian analysis package
library(rstan) # R package for writing stan models
library(lme4) # Linear, generalised linear, and nonlinear mixed models
library(mgcv) # Package for GAMs
library(lqmm) # Linear Quatile Mixed Models (Hierarchical Quantile)
library(quantreg) # Quantile Regression
library(bamlss) # Bayesian Additive Models for Location Scale and Shape

library(PerformanceAnalytics)
```

Then lets load the data:

```{r load_data}


rhomis_df <- readr::read_csv("./data/prepared-data/rhomis-geo-data.csv")

# Here we create a "geographic copy" of the dataset
rhomis_geo_data <- sf::st_as_sf(x = rhomis_df, wkt = "geometry")
rhomis_geo_data <- rhomis_geo_data[rhomis_geo_data$iso_3!="NER",]

# IPUMS GEO2 level dataset
ipums_df <- readr::read_csv("./data/prepared-data/ipums-all.csv")
ipums_geo <- sf::st_as_sf(x = ipums_df, wkt = "geometry")
ipums_geo <- ipums_geo[ipums_geo$iso_3!="NER",]


# lsms_all <- readr::read_csv("./data/prepared-data/lsms-all.csv")

# There are a lot of variables to examine in the dataset, 
# in this file we have organised them into categories
variable_categories <- jsonlite::read_json("./data/variable-categorisation.json")


world_all <- readr::read_csv("./data/prepared-data/world-shapefile.csv")
world_all <- sf::st_as_sf(x = world_all, wkt = "geometry")
```
So what are these datasets? `rhomis_df` is a set of RHoMIS
indicators, with their GPS coordinates. These indicators 
have been linked to subnational level (GEO2) IPUMS census 
data. 


# Computing Indicators

There are many indicators in the RHoMIS dataset, however, we might want to
compute some further indicators.

All of the income units come in local currency units. I would like currencies to
be internationally comparable, so I am going to change them to PPP$ (purchasing
power parity).

```{r PPP}

income_columns_lcu <- c(
  "crop_income_lcu_per_year",
  "livestock_income_lcu_per_year",
  "total_income_lcu_per_year",
  "off_farm_income_lcu_per_year",
  "value_crop_consumed_lcu_per_hh_per_year",
  "value_livestock_products_consumed_lcu_per_hh_per_year",
  "value_farm_products_consumed_lcu_per_hh_per_year"
)
income_columns_ppp <- gsub("lcu", "ppp", income_columns_lcu)
rhomis_df[income_columns_ppp] <- rhomis_df[income_columns_lcu]/rhomis_df$currency_conversion_lcu_to_ppp

# Population columns came in form of totals
# Convert these into percentages for comparison
# between locations

population_columns_percentage <- paste0(
  variable_categories$ipums$population_columns,
  "_perc"
)

ipums_df[population_columns_percentage] <- 100*ipums_df[unlist(variable_categories$ipums$population_columns)]/ipums_df$TOTPOP_GEO2A

rhomis_df[population_columns_percentage] <- 100*rhomis_df[unlist(variable_categories$ipums$population_columns)]/rhomis_df$TOTPOP_GEO2A


# There are duplicate GEOID's by country, so need to create country specific IDs

ipums_df$GEOID_country <- paste0(ipums_df$GEOID, "_" ,ipums_df$iso_2)
rhomis_df$GEOID_country <- paste0(rhomis_df$GEOID, "_" ,rhomis_df$iso_2)


# It can be useful, for exploration, to understand the 
# different countries by region. 

region_table <- tibble::as_tibble(
  list(
    "iso_2"=c("BF", 
              "ET", 
              "GH", 
              "KE",
              "ML",
              "NG",
              "RW",
              "TZ",
              "UG"),
    "region_afr"=c("west_africa",
                   "east_africa", 
                   "west_africa", 
                   "east_africa", 
                   "west_africa",
                   "west_africa",
                   "central_africa",
                   "east_africa",
                   "east_africa"
                   
                  
                   )
  )
)

ipums_df <- ipums_df %>% left_join(region_table, by = "iso_2")
rhomis_df <- rhomis_df %>% left_join(region_table, by = "iso_2")




```


## Assessing Data Coverage and Completeness

We are interested in the distribution 
of farm characteristics at the subnational level. 
To assess a "distribution", we would need a sufficient
number of households.


``` {r plot_map, eval=F}
ggplot() +
  geom_sf(data=world_all, size=0.5) +
  geom_sf(data=ipums_geo, color="black", size=0.1,aes(fill=iso_3))  +
  geom_sf(data=rhomis_geo_data, size=0.1) +
  coord_sf(xlim = c(bounding_box$xmin, bounding_box$xmax), ylim = c(bounding_box$ymin, bounding_box$ymax))
```
![](./outputs/r_outputs/exploratory/subnational_boundaries.png)
```{r, echo=F, fig.align='center'}
households_per_country <- rhomis_df %>% 
  filter(!is.na(iso_2)) %>% 
  group_by(iso_2) %>% 
  summarise(
    number_of_households=dplyr::n()
  )

households_per_country <- households_per_country %>% left_join(region_table, by="iso_2")


ggplot(households_per_country, aes(x=iso_2, y=number_of_households, fill=region_afr))+
  geom_bar(stat="identity")+
  labs(title="Number of RHoMIS Surveys by Country",
        x ="ISO Country Code", y = "Number RHoMIS Surveys")




areas_in_rhomis <- ipums_df %>% 
  # Select columns
  select(c("iso_2", "GEOID_country", "GEO2LABEL")) %>% 
  # Add a True/False column, whether the GEOID is in RHoMIS
  mutate(
    in_rhomis = ipums_df$GEOID_country %in% rhomis_df$GEOID_country,
    ) %>% 
  group_by(iso_2) %>% 
  # Get the country summary of number of areas, and nuber of rhomis areas
  summarise(
    number_of_GEO2=dplyr::n(),
    GEO2_with_rhomis=sum(in_rhomis==T)
  ) %>% 
  # Calculate the percentage of areas covered
mutate(
  coverage = 100*GEO2_with_rhomis/number_of_GEO2,
)


areas_in_rhomis <- areas_in_rhomis %>% left_join(region_table, by="iso_2")


ggplot(areas_in_rhomis, aes(x=iso_2, y=coverage, fill=region_afr))+
  geom_bar(stat="identity")+
  labs(title="Percentage of GEO2 Areas Containing RHoMIS Surveys",
        x ="ISO Country Code", y = "Percentage of Areas with RHoMIS Surveys")


# knitr::kable(areas_in_rhomis)

# stats_per_area <- rhomis_df %>% 
#   group_by(iso_2, GEO2LABEL) %>% 
#   summarise(
#     households_per_area=dplyr::n()
#   ) %>% 
#   group_by(iso_2) %>% 
#   summarise(
#     hh_per_geo2_mean=mean(households_per_area),
#     hh_per_geo2_lq=quantile(households_per_area, 0.25, na.rm=T),
#     hh_per_geo2_median=quantile(households_per_area, 0.5, na.rm=T),
#     hh_per_geo2_uq=quantile(households_per_area, 0.75, na.rm=T),
#     hh_per_geo2_iqr=IQR(households_per_area, 0.75, na.rm=T),
# 
#     hh_per_geo2_sd=sd(households_per_area)
# 
#   )

stats_per_area <- rhomis_df %>% 
  filter(!is.na(iso_2))%>% 
  group_by(iso_2, GEO2LABEL) %>% 
  summarise(
    households_per_area=dplyr::n()
  ) 

stats_per_area <- stats_per_area %>% left_join(region_table, by="iso_2")


ggplot(stats_per_area, aes(x=iso_2, y=households_per_area, fill=region_afr))+
  geom_boxplot()+
  labs(title="Number of RHoMIS Surveys in GEO2 Households",
        x ="ISO Country Code", y = "Number of Households in Area")


```


## Country Selection

Based on the plots above, there are three candidates from the dataset which
have helpfule characteristics:

1. They have a relatively large number of surveys (n>2000)
2. They have surveys in a significant portion of their subnational areas (>40%)

The three countries are Burkina Faso (West Africa), Rwanda (Central Africa), and Tanzania (East Africa).




# What Can Land Size Tell Us

```{r land_size_1, fig.align='center'}

land_size_df <- rhomis_df %>% 
  filter(!is.na(iso_2)) 
  

ggplot(land_size_df, aes(x=iso_2, y=land_cultivated_ha, fill=region_afr))+
  geom_boxplot()+
    scale_y_continuous(limits = quantile(rhomis_df$land_cultivated_ha, c(0, 0.95), na.rm = T))+
  labs(title="Land Cultivated (ha) per Country",
        x ="ISO Country Code", y = "Land Cultivated (ha)")



```

Here we see that we have a wide range of land size distributions,
each of which vary quite significantly by country.

### Land Size Correlations

As mentioned, land size could provide important information on
poverty levels or food security


```{r land_size_2, fig.align='center'}

rhomis_no_na <- rhomis_df %>% 
  filter(!is.na(iso_2)) %>% 
    filter(!is.na(land_cultivated_ha)) 


bin_number <- 10
land_quartiles <- quantile(rhomis_df$land_cultivated_ha, seq(0,1,1/bin_number), na.rm=T)

x_gt_cond <- land_quartiles[1:(length(land_quartiles)-1)]
x_ls_cond <- land_quartiles[2:length(land_quartiles)]
x_quarts <- paste0("q",c(1:bin_number))
cases <- paste0('land_cultivated_ha >= ', x_gt_cond, ' & land_cultivated_ha < ', x_ls_cond, ' ~ "', x_quarts, '"')


rhomis_no_na <- rhomis_df %>% mutate(land_quantiles = dplyr::case_when(!!!rlang::parse_exprs(cases)))
rhomis_no_na$land_quantiles <- factor(rhomis_no_na$land_quantiles, levels=x_quarts, ordered=T)



ggplot(rhomis_no_na, aes(x=land_quantiles, y=total_income_ppp_per_year)) +
  geom_boxplot()+
  scale_y_continuous(limits = quantile(rhomis_no_na$total_income_ppp_per_year, c(0, 0.8), na.rm = T))








```


```{r land_size_3, fig.align='center'}

```


# Subnational Level Covariates

```{r ipums_cov, fig.align='center'}






pca_data <- ipums_df[
      unlist(variable_categories$ipums$economic_subnational_indicators),
    unlist(variable_categories$ipums$population_columns_percentage),
    unlist(variable_categories$ipums$employment_columns),
    unlist(variable_categories$ipums$landscape_variables)
  
  ]

#chart.Correlation(pca_data, histogram=TRUE, pch=19)


res.pca <- FactoMineR::PCA(pca_data, ncp=20)

res.pca$eig


fviz_screeplot(res.pca, ncp=20)
fviz_pca_var(res.pca)

summary(my_gam)
gam.check(my_gam)

plot(my_gam)

```


```{r gam_attempt}

y <- "land_cultivated_ha"
sep <- "~"

dep_vars <- paste0(c(
    unlist(variable_categories$ipums$economic_subnational_indicators),
    unlist(variable_categories$ipums$population_columns_percentage),
    unlist(variable_categories$ipums$employment_columns),
    unlist(variable_categories$ipums$landscape_variables)
  ), collapse=") + s(")
dep_vars <- paste0("s(",dep_vars,")")

formula <- as.formula(paste0(y, sep, dep_vars, collapse = " "))

my_gam <- mgcv::gam(
  data=rhomis_df,
  formula = formula,
  method="REML")





```